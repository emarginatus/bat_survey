---
author: "Thierry Onkelinx"
date: "`r paste('Versie:', format(Sys.time(), '%e/%m/%Y %T %Z'))`"
output: pdf_document
params:
  studyarea: 1
  crs: "+init=epsg:31370"
  cellsize: 100
---

```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(
  cache = TRUE,
  autodep = TRUE,
  message = FALSE,
  echo = FALSE
)
library(rgdal)
library(rgeos)
library(osmar)
library(dplyr)
library(ggplot2)
```

```{r load_data}
studyarea <- readOGR("studyarea.geojson", verbose = FALSE) %>%
  subset(id = params$studyarea)
```

---
title: "`r paste('Veldformulier', studyarea$name)`"
---

+-----------------+-------------------------------------------------------+
| Datum:          |                                                       |
+-----------------+-------------------------------------------------------+
|                 |                                                       |
+-----------------+-------------------------------------------------------+
| Onderzoeker 1 : |                                                       |
+-----------------+-------------------------------------------------------+
|                 |                                                       |
+-----------------+-------------------------------------------------------+
| Onderzoeker 2 : |                                                       |
+-----------------+-------------------------------------------------------+
|                 |                                                       |
+-----------------+-------------------------------------------------------+
| Onderzoeker 3 : |                                                       |
+-----------------+-------------------------------------------------------+
|                 |                                                       |
+-----------------+-------------------------------------------------------+
| Onderzoeker 4 : |                                                       |
+-----------------+-------------------------------------------------------+
|                 |                                                       |
+-----------------+-------------------------------------------------------+
| Onderzoeker 5 : |                                                       |
+-----------------+-------------------------------------------------------+
|                 |                                                       |
+-----------------+-------------------------------------------------------+


```{r project}
studyarea_proj <- spTransform(studyarea, CRS(params$crs))
studyarea_buffer <- studyarea_proj %>%
  gBuffer(width = 5 * params$cellsize) %>%
  spTransform(CRS("+proj=longlat"))
```

```{r find_optimal_angle}
raw_coordinates <- lapply(
  studyarea_proj@polygons,
  function(x){
    x@Polygons %>%
      lapply(coordinates) %>%
      do.call(what = "rbind")
  }
) %>%
  do.call(what = "rbind")
center <- apply(raw_coordinates, 2, range) %>%
  colMeans()
raw_coordinates <- raw_coordinates - matrix(center, byrow = TRUE, ncol = 2, nrow = nrow(raw_coordinates))
bb_area <- function(raw_coordinates, angle){
  raw_coordinates %*%
    matrix(c(cos(angle), sin(angle), -sin(angle), cos(angle)), ncol = 2) %>%
    apply(2, range) %>%
    apply(2, diff) %>%
    prod()
}
angle <- optimize(bb_area, interval = c(0, -pi / 2), raw_coordinates = raw_coordinates)$minimum
```

```{r rotate_studyarea}
studyarea_local <- studyarea_proj
studyarea_local@proj4string <- CRS("")
studyarea_local@polygons <- lapply(
  studyarea_local@polygons,
  function(x){
    x@Polygons <- lapply(
      x@Polygons,
      function(y){
        y@coords <- -matrix(center, byrow = TRUE, ncol = 2, nrow = nrow(y@coords)) %>%
          "+"(y@coords) %>%
          "%*%"(matrix(c(cos(angle), sin(angle), -sin(angle), cos(angle)), ncol = 2))
        return(y)
      }
    )
    return(x)
  }
)
studyarea_df <- fortify(studyarea_local)
```

```{r local_grid}
grid_df <- expand.grid(
  long = seq(
    min(studyarea_df$long),
    max(studyarea_df$long),
    by = params$cellsize
  ),
  lat = seq(
    min(studyarea_df$lat),
    max(studyarea_df$lat),
    by = params$cellsize
  )
)
grid_local <- lapply(
  seq_along(grid_df$long), 
  function(i){
    cbind(
      grid_df$long[i] + params$cellsize * c(0, 1, 1, 0, 0),
      grid_df$lat[i] + params$cellsize * c(0, 0, 1, 1, 0)
    ) %>%
      Polygon() %>%
      list() %>%
      Polygons(ID = i)
  }
) %>%
  SpatialPolygons()
overlap <- gRelate(studyarea_local, grid_local, byid = TRUE) %>%
  as.vector() %>%
  grepl(pattern = "^2")
grid_local <- grid_local[overlap, ]
grid_df <- fortify(grid_local)
```

```{r import_osm}
osm <- as_osmar_bbox(studyarea_buffer) %>%
  get_osm()
```

```{r osm_local_coordinates}
osm_local <- SpatialPointsDataFrame(
  coords = osm$nodes$attrs %>%
    select(long = lon, lat), 
  data = osm$nodes$attrs %>%
    select(ref = id), 
  proj4string = studyarea@proj4string
) %>%
  spTransform(CRS(params$crs)) %>%
  as.data.frame() %>%
  mutate(
    x = long - center[1], 
    y = lat - center[2],
    long = cos(angle) * x + sin(angle) * y,
    lat = -sin(angle) * x + cos(angle) * y
  ) %>%
  select(-x, -y)
```

```{r osm_layers}
road <- osm$ways$tags %>%
  filter(k == "highway") %>%
  inner_join(osm$ways$refs, by = "id") %>%
  inner_join(osm_local, by = "ref")
waterway <- osm$ways$tags %>%
  filter(k == "waterway") %>%
  inner_join(osm$ways$refs, by = "id") %>%
  inner_join(osm_local, by = "ref")
forest <- osm$ways$tags %>%
  filter(k == "landuse", v == "forest") %>%
  inner_join(osm$ways$refs, by = "id") %>%
  inner_join(osm_local, by = "ref") %>%
  select(id, long, lat)
forest <- osm$relations$tags %>%
  filter(k == "landuse", v == "forest") %>%
  inner_join(osm$relations$refs, by = "id") %>%
  inner_join(osm$ways$refs, by = c("ref" = "id")) %>%
  inner_join(osm_local, by = c("ref.y" = "ref")) %>%
  select(id, long, lat) %>%
  bind_rows(forest)
water <- osm$ways$tags %>%
  filter(k == "natural", v == "water") %>%
  inner_join(osm$ways$refs, by = "id") %>%
  inner_join(osm_local, by = "ref") %>%
  select(id, long, lat)
water <- osm$relations$tags %>%
  filter(k == "natural", v == "water") %>%
  inner_join(osm$relations$refs, by = "id") %>%
  inner_join(osm$ways$refs, by = c("ref" = "id")) %>%
  inner_join(osm_local, by = c("ref.y" = "ref")) %>%
  select(id, long, lat) %>%
  bind_rows(water)
grass <- osm$ways$tags %>%
  filter((k == "natural" & v == "grasland") | (k == "landuse" & v %in% c("grass", "meadow"))) %>%
  inner_join(osm$ways$refs, by = "id") %>%
  inner_join(osm_local, by = "ref") %>%
  select(id, long, lat)
grass <- osm$relations$tags %>%
  filter((k == "natural" & v == "grasland") | (k == "landuse" & v %in% c("grass", "meadow"))) %>%
  inner_join(osm$relations$refs, by = "id") %>%
  inner_join(osm$ways$refs, by = c("ref" = "id")) %>%
  inner_join(osm_local, by = c("ref.y" = "ref")) %>%
  select(id, long, lat) %>%
  bind_rows(grass)
building <- osm$ways$tags %>%
  filter(k == "building") %>%
  inner_join(osm$ways$refs, by = "id") %>%
  inner_join(osm_local, by = "ref") %>%
  select(id, long, lat)
```

```{r fig.cap = "Overzicht"}
ggplot(studyarea_df, aes(x = long, y = lat)) +
  geom_polygon(data = water, aes(group = id), fill = "blue") +
  geom_polygon(data = forest, aes(group = id), fill = "darkgreen") +
  geom_polygon(data = grass, aes(group = id), fill = "green") +
  geom_polygon(data = building, aes(group = id), fill = "red") +
  geom_polygon(aes(group = group), fill = NA, colour = "black", size = 2) +
  geom_polygon(data = grid_df, aes(group = group), fill = NA, colour = "black") +
  geom_path(data = waterway, aes(group = id), colour = "blue") +
  geom_path(data = road, aes(group = id), colour = "grey") +
  coord_fixed(
    xlim = range(grid_df$long),
    ylim = range(grid_df$lat)
  ) +
  theme(
    axis.text = element_blank(), 
    axis.title = element_blank(),
    axis.ticks = element_blank(),
    panel.background = element_blank(),
    panel.grid = element_blank()
  )
```
