---
title: "Field forms"
author: "Thierry Onkelinx"
date: "`r format(Sys.time(), '%e/%m/%Y %T %Z')`"
output: html_document
params:
  studyarea: 1
  crs: "+init=epsg:31370"
  cellsize: 100
---

```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(
  cache = TRUE,
  autodep = TRUE,
  echo = FALSE
)
library(rgdal)
library(rgeos)
library(dplyr)
library(ggplot2)
```

```{r load_data}
studyarea <- readOGR("studyarea.geojson", verbose = FALSE) %>%
  subset(id = params$studyarea)
```

```{r project}
studyarea_proj <- spTransform(studyarea, CRS(params$crs))
```

```{r find_optimal_angle}
raw_coordinates <- lapply(
  studyarea_proj@polygons,
  function(x){
    x@Polygons %>%
      lapply(coordinates) %>%
      do.call(what = "rbind")
  }
) %>%
  do.call(what = "rbind")
center <- apply(raw_coordinates, 2, range) %>%
  colMeans()
raw_coordinates <- raw_coordinates - matrix(center, byrow = TRUE, ncol = 2, nrow = nrow(raw_coordinates))
bb_area <- function(raw_coordinates, angle){
  raw_coordinates %*%
    matrix(c(cos(angle), sin(angle), -sin(angle), cos(angle)), ncol = 2) %>%
    apply(2, range) %>%
    apply(2, diff) %>%
    prod()
}
angle <- optimize(bb_area, interval = c(0, -pi / 2), raw_coordinates = raw_coordinates)$minimum
```

```{r rotate_studyarea}
studyarea_local <- studyarea_proj
studyarea_local@proj4string <- CRS("")
studyarea_local@polygons <- lapply(
  studyarea_local@polygons,
  function(x){
    x@Polygons <- lapply(
      x@Polygons,
      function(y){
        y@coords <- -matrix(center, byrow = TRUE, ncol = 2, nrow = nrow(y@coords)) %>%
          "+"(y@coords) %>%
          "%*%"(matrix(c(cos(angle), sin(angle), -sin(angle), cos(angle)), ncol = 2))
        return(y)
      }
    )
    return(x)
  }
)
studyarea_local <- fortify(studyarea_local)
```

```{r}
ggplot(studyarea_local, aes(x = long, y = lat)) +
  geom_polygon(aes(group = group), fill = NA, colour = "black") +
  coord_fixed() +
  theme(
    axis.text = element_blank(), 
    axis.title = element_blank(),
    axis.ticks = element_blank(),
    panel.background = element_blank(),
    panel.grid = element_blank()
  )
```
